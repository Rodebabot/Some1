import pandas as pd

# Ensure 'Days Spent' column is numeric
action['Days Spent'] = pd.to_numeric(action['Days Spent'], errors='coerce')

# Group by Counterparty Name and ROC, then calculate the median of Days Spent
median_days = action.groupby(['Counterparty Name', 'ROC'])['Days Spent'].median().reset_index()

# Pivot the table to have ROCs as columns
pivot_table = median_days.pivot(index='Counterparty Name', columns='ROC', values='Days Spent').reset_index()

# Function to highlight the top 3 values in each row
def highlight_top3(s):
    is_top3 = s.nlargest(3).isin(s)
    return ['background-color: yellow' if v else '' for v in is_top3]

# Apply highlighting function to the DataFrame
highlighted_table = pivot_table.style.apply(highlight_top3, axis=1)

# Save to CSV
pivot_table.to_csv('/mnt/data/median_days_per_counterparty.csv', index=False)

# Save the highlighted table to an Excel file
highlighted_table.to_excel('/mnt/data/median_days_per_counterparty_highlighted.xlsx', index=False)

highlighted_table
