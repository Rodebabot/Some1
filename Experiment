import win32com.client
import pandas as pd
from datetime import datetime

# Initialize Outlook application
outlook = win32com.client.Dispatch("Outlook.Application")
namespace = outlook.GetNamespace("MAPI")

# Access the mailbox (replace 'SADDA' with the exact name of your mailbox)
mailbox = namespace.Folders['SADDA']

# Get today's date in the correct format
today = datetime.today().date()

# Function to search through folders and subfolders
def search_folder(folder):
    emails = []
    for item in folder.Items:
        if item.Class == 43:  # Mail item
            received_time = item.ReceivedTime
            if received_time.date() == today:
                if "OTCWORK" in item.Body:
                    emails.append({
                        'Subject': item.Subject,
                        'ReceivedTime': received_time
                    })
    for subfolder in folder.Folders:
        emails += search_folder(subfolder)
    return emails

# Start searching from the inbox or the root of the mailbox
inbox = mailbox.Folders['Inbox']
emails = search_folder(inbox)

# Create a DataFrame and save to Excel
df = pd.DataFrame(emails)
df.to_excel('OTCWORK_emails_today.xlsx', index=False)

print("Excel file created successfully.")
