import tkinter as tk
from tkinter import ttk
import openpyxl
import win32com.client as win32
from datetime import datetime

class OutlookApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Outlook Mailbox Viewer")
        self.outlook = win32.Dispatch("Outlook.Application").GetNamespace("MAPI")
        self.create_ui()

    def connect_outlook(self, folder_name):
        try:
            inbox = self.outlook.GetDefaultFolder(6)  # 6 corresponds to the Inbox folder
            subfolder = inbox.Folders(folder_name)
            messages = subfolder.Items
            messages.Sort("[ReceivedTime]", True)  # Sort by ReceivedTime in descending order
            return messages
        except Exception as e:
            print(f"Error connecting to Outlook: {e}")
            return None

    def load_excel_sheet(self, file_path):
        try:
            workbook = openpyxl.load_workbook(file_path)
            sheet = workbook.active
            email_filter = set(sheet['A'][1:])  # Assuming domain names or email parts are in column A
            return email_filter
        except Exception as e:
            print(f"Error loading Excel sheet: {e}")
            return set()

    def display_emails(self, folder_name, email_filter):
        messages = self.connect_outlook(folder_name)
        if messages:
            self.email_listbox.delete(0, tk.END)
            for message in messages:
                sender = message.SenderEmailAddress
                if any(filter_item in sender for filter_item in email_filter):
                    subject = message.Subject
                    received_time = message.ReceivedTime.strftime("%Y-%m-%d %H:%M:%S")
                    self.email_listbox.insert(tk.END, f"{subject} - {sender} - {received_time}")

    def draft_reply(self, selected_item):
        # Implement drafting automated reply
        pass

    def create_ui(self):
        tk.Label(self.root, text="Select Folder:").pack()
        folder_combobox = ttk.Combobox(self.root, values=["Inbox", "Sent Items"])  # Add more folders if needed
        folder_combobox.set("Inbox")
        folder_combobox.pack()

        tk.Label(self.root, text="Load Excel Sheet:").pack()
        file_entry = tk.Entry(self.root)
        file_entry.pack()

        load_button = tk.Button(self.root, text="Load", command=lambda: self.load_and_display(folder_combobox.get(), file_entry.get()))
        load_button.pack()

        self.email_listbox = tk.Listbox(self.root, width=50, height=10)
        self.email_listbox.pack()

        reply_button = tk.Button(self.root, text="Draft Reply", command=lambda: self.draft_reply(self.email_listbox.get(tk.ACTIVE)))
        reply_button.pack()

    def load_and_display(self, folder_name, file_path):
        email_filter = self.load_excel_sheet(file_path)
        self.display_emails(folder_name, email_filter)

if __name__ == "__main__":
    root = tk.Tk()
    app = OutlookApp(root)
    root.mainloop()
