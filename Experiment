import pandas as pd

# List of specified ROCs
specified_rocs = [
    'counterpartytoaction', 
    'cptytoactioneconomicbreak', 
    'cptytoactiontemplatenegotiation'
]

# Ensure 'Days Spent' column is numeric
action['Days Spent'] = pd.to_numeric(action['Days Spent'], errors='coerce')

# Filter the dataframe to include only the specified ROCs
filtered_action = action[action['ROC'].isin(specified_rocs)]

# Group by Counterparty Name, ROC, Business Event, and Product Representation, then calculate the median of Days Spent
median_days = filtered_action.groupby(['Counterparty Name', 'ROC', 'Business Event', 'Product Representation'])['Days Spent'].median().reset_index()

# For each specified ROC, find the top 30 counterparties with the highest median Days Spent
top_30_per_roc = pd.DataFrame()

for roc in specified_rocs:
    top_30 = median_days[median_days['ROC'] == roc].nlargest(30, 'Days Spent')
    top_30['Rank'] = top_30['Days Spent'].rank(ascending=False)
    top_30_per_roc = pd.concat([top_30_per_roc, top_30])

# Save to CSV
top_30_per_roc.to_csv('/mnt/data/top_30_counterparties_per_roc.csv', index=False)

top_30_per_roc
