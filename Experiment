# Identify unique event IDs in the bottlenecks
bottleneck_event_ids = df[df.apply(lambda row: (row['ROC'], row['Age Band']) in bottlenecks[['ROC', 'Age Band']].apply(tuple, axis=1).values, axis=1)]['Unique Eventid'].unique()

# Filter data for these event IDs
bottleneck_data = df[df['Unique Eventid'].isin(bottleneck_event_ids)]

# Analyze contributing factors
contributing_factors = bottleneck_data.groupby(['ROC', 'Age Band', 'Legal Entity', 'Business Event', 'Product Representation'])['Days Spent'].agg(['count', 'mean']).reset_index()

# Display contributing factors
print(contributing_factors)

# Save the contributing factors to an Excel file
contributing_factors.to_excel('/mnt/data/contributing_factors_analysis.xlsx', index=False)

print("Contributing factors analysis saved to contributing_factors_analysis.xlsx")
